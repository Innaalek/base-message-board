<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Base Message Board</title>
  <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body style="margin:0;background:#0a0a0f;color:white;font-family:Arial;padding:20px">
<div id="app"></div>

<script>
const e = React.createElement;
const contractAddress = "0x2E1476Ba7D284e931389710904569FFdd1eC10F1";
const abi = [
  "function postMessage(string _text) external",
  "function getMessagesCount() view returns (uint256)",
  "function getLatestMessage() view returns (tuple(address user, string text, uint256 timestamp))"
];

function App() {
  const [account, setAccount] = React.useState(null);
  const [message, setMessage] = React.useState("");
  const [count, setCount] = React.useState("0");
  const [latest, setLatest] = React.useState(null);

  async function connectWallet() {
    if (!window.ethereum) return alert("MetaMask not found");
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    setAccount(accounts[0]);
    fetchData();
  }

  async function fetchData() {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const contract = new ethers.Contract(contractAddress, abi, provider);
    const c = await contract.getMessagesCount();
    setCount(c.toString());
    try {
      const l = await contract.getLatestMessage();
      setLatest(l);
    } catch {}
  }

  async function sendMessage() {
    if (!account) return alert("Connect wallet first");
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    const contract = new ethers.Contract(contractAddress, abi, signer);
    const tx = await contract.postMessage(message);
    await tx.wait();
    setMessage("");
    fetchData();
  }

  return e("div", null,
    e("button", {onClick: connectWallet, style:{padding:"10px 16px",borderRadius:"6px",fontSize:"16px",cursor:"pointer"}},
      account ? "Wallet: " + account.slice(0,6) + "..." : "Connect MetaMask"
    ),
    e("h3", {style:{marginTop:"20px"}}, "Write a message"),
    e("textarea", {value:message, onChange:(ev)=>setMessage(ev.target.value), rows:3, style:{width:"100%",borderRadius:"6px",padding:"10px",marginTop:"8px"}}),
    e("button", {onClick:sendMessage, style:{width:"100%",padding:"12px",borderRadius:"6px",fontSize:"18px",cursor:"pointer",marginTop:"10px"}}, "Publish"),
    e("p", {style:{marginTop:"20px"}}, "Total on-chain messages: " + count),
    latest && e("div", {style:{background:"#1a1a25",padding:"12px",borderRadius:"8px",marginTop:"12px"}},
      e("p", null, `"${latest.text}"`),
      e("small", null, "From " + latest.user.slice(0,6)+"... | " + new Date(Number(latest.timestamp)*1000).toLocaleString())
    )
  );
}

ReactDOM.render(e(App), document.getElementById("app"));
</script>
</body>
</html>
